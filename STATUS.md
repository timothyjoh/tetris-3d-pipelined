# Project Status

> Auto-generated by cc-pipeline. Last updated after Phase 5.

## Overview
A single-page Tetris clone built with Three.js and Vite, deployable to Vercel. Classic 2D Tetris mechanics rendered with a Tron-inspired neon aesthetic — dark background, glowing emissive blocks, grid overlay, and bloom post-processing.

**Current state:** The game is fully playable end-to-end with a true 3D visual presentation and automated E2E test coverage. Open `localhost:5173` after `npm run dev` to get all 7 tetrominoes falling in perspective, keyboard controls, wall kicks, line clearing, scoring, and leveling. The Three.js renderer shows neon-colored 3D cube blocks with bloom glow, face shading from a directional light, a grid overlay, a ghost piece preview, lock flash on piece placement, and a left-to-right sweep animation on line clear. The board tilts up to ±7° on the Y-axis (the active piece's side leans toward the viewer) and snaps back on landing. Eight synthesized 8-bit sound effects play for every action. On game over, qualifying scores trigger an arcade-style 3-character initials prompt; the leaderboard table is shown after submission and the top-10 persists across page reloads in localStorage. Playwright E2E tests run against the production build and produce `.webm` video recordings of every test scenario.

---

## Phase 1: Tetris Engine + Three.js Rendering + Tron Aesthetic

### What We Built
- Complete Vite + Vanilla JS project scaffold replacing a prior unrelated `mdtoc` CLI config
- Pure-JS Tetris engine (`src/engine/`): 10×20 board, all 7 tetrominoes with SRS rotation and wall kicks, standard gravity speed curve (1000ms→17ms across 20 levels), 500ms lock delay with 15-reset cap, line clear + row shift, scoring (100/300/500/800 × level), level progression every 10 lines
- Three.js WebGL renderer: `WebGLRenderer`, `OrthographicCamera`, pre-allocated 220-mesh block pool toggled per frame (no per-frame GC), `MeshStandardMaterial` with `emissive` color for neon look
- `UnrealBloomPass` post-processing via `EffectComposer` + `OutputPass` using `three/addons/` (no extra npm package)
- `LineSegments` grid overlay on the board; dark background plane behind cells
- DOM HUD over the canvas: live score, level, lines cleared, next-piece preview (2D canvas), game-over overlay with "PLAY AGAIN" button
- Keyboard controls: Arrow Left/Right (move), Arrow Up / X (rotate CW), Z (rotate CCW), Arrow Down (soft drop), Space (hard drop), P (pause)
- `AGENTS.md`, `README.md`, `CLAUDE.md` updates

### How to Run It
```
npm install
npm run dev      # open localhost:5173
```
A piece spawns immediately and falls. Use arrow keys and Space to play. P pauses. On game over, click "PLAY AGAIN" to restart. Production build: `npm run build` → `dist/index.html`.

### Review Findings
- **Lock delay bug (fixed):** Initial implementation accumulated `_lockAccum` with the gravity period instead of real `dt`, so at level 1 the piece locked on the first gravity tick (~1000ms) rather than after an independent 500ms window. Fixed by restructuring `update()` to accumulate lock time every frame when `_landed === true`, independent of gravity cadence.
- **Incomplete 4-line clear test (fixed):** A test left a wrong bug comment claiming `clearRows` had a splice/unshift issue; the implementation was actually correct. Test was rewritten with full row-shift assertions.
- **`update(dt)` untested initially (fixed):** The core gravity/lock loop had 0% function coverage in the first pass. Six tests were added covering gravity ticks, lock-after-500ms, soft drop interval selection, and pause/over guards.
- **Multi-line scoring missing (fixed):** 2-line (300pts), 4-line (800pts), and level-multiplier (200pts for 1-line at level 2) tests were added.
- **Deferred (known debt):** Redundant `isInBounds` check in `board.js:42`, dead `onRestart` callback parameter in `input.js`, redundant `randomPieceType()` call in `restart()`, no keyboard restart shortcut (mouse click only).

### What's Next
- **Phase 2:** Board tilt effect — Z-axis rotation tracking active piece column (±7° max), spring/damping oscillation back to 0° on piece landing. Web Audio API 8-bit sound effects (move, rotate, soft/hard drop, line clear, Tetris, level up, game over). Polish: ghost piece preview, lock flash, line-clear animation.
- **Phase 3:** Local leaderboard (top 10 in localStorage), initials entry on game over, Vercel deploy config, final QA.
- Known limitations: keyboard-only (no mobile touch), no sound, no ghost piece, no leaderboard.

### Test Coverage
- **Test command:** `npm run test` / `npm run test:coverage`
- **Results:** 115 tests passing, 0 failing across 4 test files
- **Coverage (engine modules):**

  | File           | Stmts  | Branch | Funcs  | Lines  |
  |----------------|--------|--------|--------|--------|
  | board.js       | 100%   | 100%   | 100%   | 100%   |
  | gameState.js   | 96.81% | 95.83% | 85.71% | 96.81% |
  | rotation.js    | 100%   | 81.81% | 100%   | 100%   |
  | tetrominoes.js | 100%   | 100%   | 100%   | 100%   |
  | **All files**  | **98.54%** | **95.5%** | **91.42%** | **98.54%** |

- Engine line coverage: **98.54%** (target: ≥ 80%)
- Not covered: renderer modules (`scene.js`, `blockPool.js`, `composer.js`, `render.js`, `hud.js`) — all require a WebGL context unavailable in Node; no E2E tests per spec

---

## Phase 2: Board Tilt, Sound Effects, and Polish

### What We Built
- **Board tilt animation** — The Three.js `boardGroup` (`THREE.Group`) rotates on the Z-axis as the active piece moves left/right, driven by a spring/damper (`velocity *= 0.75`, spring constant 0.15). Tilt snaps back toward 0° the frame a piece locks (`justLocked` one-frame flag). All grid lines, the background plane, and block meshes tilt together as a unit. Tilt is purely cosmetic — game-logic coordinates are unchanged.
- **Ghost piece** — `computeGhostRow()` in `src/engine/ghost.js` computes the hard-drop landing row each frame. `BoardRenderer.draw()` renders the ghost at that row using the existing block pool with a low emissive intensity (0.15), giving a dim neon outline. No per-frame allocation.
- **Piece lock flash** — On `_lockPiece()`, locked cell coordinates are saved to `gameState.flashCells`. The renderer overrides those cells to full white (`emissiveIntensity = 1.5`) for 100ms, then clears automatically. Flash timer runs even while the game is over so it always expires.
- **Line-clear sweep animation** — When rows complete, `_lockPiece()` enters a 150ms sweep mode instead of immediately clearing. `gameState.sweeping`, `sweepRows`, and `sweepProgress` (0→1 getter) are exposed for the renderer. Gravity does not tick during the sweep. `_finalizeSweep()` then clears rows, updates score/level, and spawns the next piece.
- **8 synthesized sound effects** — `src/audio/sounds.js` exports `playTone(freq, duration, type, gainEnvelope?, ctx?)` and `playGameSound(event, ctx)`. All audio uses `AudioContext` + `OscillatorNode` + `GainNode`; every oscillator is stopped and disconnected via `onended` — no audio-graph leaks. Sounds: move (200 Hz square), rotate (300 Hz square), softDrop (150 Hz square), hardDrop (440 Hz square), lineClear (600 Hz square), tetris (880 Hz square), levelUp (1000 Hz sine), gameOver (110 Hz sawtooth). The `AudioContext` is created lazily on first keypress to satisfy browser autoplay policies.
- **Sound event queue** — Engine methods push string event names to `gameState.soundEvents[]`; `main.js` RAF loop consumes and clears the array each frame via `playGameSound`. Engine stays free of browser API dependencies.
- **Keyboard restart** — `input.js` now handles Enter/R when `gameState.over === true`, calling the `onRestart` callback. These keys are ignored during active play.
- **Tech debt** — Removed the redundant `randomPieceType()` call in `restart()`; wired the previously unused `onRestart` parameter in `input.js`; raised `vite.config.js` chunk-size warning limit to 600 kB (eliminating the build warning).

### How to Run It
```
npm install
npm run dev      # open localhost:5173
```
All Phase 1 controls still apply. New in Phase 2: the board visibly tilts as you move the piece left/right; a dim ghost outline shows where the piece will land; a white flash appears on locked cells; cleared rows briefly glow before vanishing; every action produces a retro 8-bit tone. On game over, press Enter or R (or click "PLAY AGAIN") to restart.

### Review Findings
- **Build chunk-size warning (fixed):** `npm run build` emitted a "chunks larger than 500 kB" warning, violating the spec's "no warnings" requirement. Fixed by adding `chunkSizeWarningLimit: 600` to `vite.config.js`.
- **Missing `levelUp` sound event test (fixed):** `_finalizeSweep()` pushes `'levelUp'` when the level increases but no test covered this path. Fixed by adding a test that sets `linesCleared = 9` before triggering a line clear to cross the level boundary.
- **Weak `playGameSound` assertions (partially fixed):** Two spot-check tests added verifying `gameOver` triggers 110 Hz sawtooth and `move` triggers 200 Hz square. Full per-event frequency/duration/type coverage is still absent.
- **Ghost piece rotation coverage (fixed):** All original ghost tests used `rotation=0`. A rotated I-piece (`rotation=1`) test was added to `ghost.test.js`.
- **`sweepProgress` clamp at 1.0 (fixed):** Edge case test added verifying `sweepProgress` returns 0 after `_finalizeSweep()` completes (not stuck at 1).
- **Tilt uses left-origin column, not piece center (deferred):** The spec says `col` should be the piece's center column. The implementation passes `gameState.col` (left-origin). For a 4-wide piece, the max achievable tilt is ~±2.33° rather than ±7°. Identified in review; not promoted to MUST-FIX. Known debt for Phase 3.
- **Sweep animation is uniform fade, not horizontal sweep (deferred):** The spec calls for a left-to-right "horizontal sweep." The implementation fades all cleared cells uniformly. Timing is correct (150ms) but visual character differs. Deferred to Phase 3.
- **`input.js` keyboard restart untested (deferred):** The Enter/R handler has no unit tests; the Node test environment cannot dispatch DOM keydown events without jsdom. Not promoted to MUST-FIX. Known gap.

### What's Next
- **Phase 3 (final MVP):** Local leaderboard — top 10 scores in `localStorage`, initials entry (3 chars, arcade style) on game over when score qualifies, ranked table displayed on game-over screen. Game-over screen redesign. Vercel deploy config. Final QA.
- **Fix tilt column (Phase 3 start):** Pass `gameState.col + pieceHalfWidth` to `computeTiltAngle` in `main.js` to restore the spec'd ±7° range. One-line fix.
- **Fix sweep visual (Phase 3 build):** Add column-gating condition in `render.js` sweep branch (`c <= Math.floor(sweepProgress * board.cols)`) to implement true left-to-right sweep.
- **Add jsdom for `input.js` tests:** Set `environment: 'jsdom'` for an `input.test.js` to cover the Enter/R handler and game-over guard.
- **Known limitations:** Keyboard-only (no mobile touch), no leaderboard, tilt max ~2.33° (not ±7°), sweep is a fade not a sweep.

### Test Coverage
- **Test command:** `npm run test` / `npm run test:coverage`
- **Results:** 163 tests passing, 0 failing across 7 test files
- **New test files added this phase:** `tilt.test.js` (11 tests), `ghost.test.js` (6 tests), `sounds.test.js` (9 tests)
- **Coverage (engine modules):**

  | File           | Stmts  | Branch | Funcs  | Lines  |
  |----------------|--------|--------|--------|--------|
  | board.js       | 100%   | 100%   | 100%   | 100%   |
  | gameState.js   | 97.8%  | 96.82% | 86.95% | 97.8%  |
  | ghost.js       | 100%   | 100%   | 100%   | 100%   |
  | rotation.js    | 100%   | 81.81% | 100%   | 100%   |
  | tetrominoes.js | 100%   | 100%   | 100%   | 100%   |
  | tilt.js        | 100%   | 100%   | 100%   | 100%   |
  | **All files**  | **98.89%** | **96.29%** | **92.5%** | **98.89%** |

- Engine line coverage: **98.89%** (target: ≥ 80%)
- Uncovered: `gameState.js` lines 162–168 (`getActivePieceCells()`, `getActivePieceColor()`) — renderer-facing methods exercised only via `render.js`; `rotation.js` branches 27/29 — wall-kick edge cases with no reachable test path
- Not covered: renderer modules and `input.js` — require WebGL context or DOM event dispatch unavailable in Node

---

## Phase 3: Leaderboard, Game-Over Screen, and Vercel Deploy

### What We Built
- **Tilt center-column fix** — `computeTiltAngle` now receives the piece's center column (`gameState.col + TETROMINOES[pieceType].width / 2`). All `TETROMINOES` entries gained a `width` property (I=4, O=2, T/S/Z/J/L=3). Board now tilts up to the spec'd ±7° instead of the previous ~2.33° max.
- **Sweep left-to-right fix** — `render.js` gates each cell in a cleared row by column index (`c < Math.floor(sweepProgress * board.cols)`), producing a true horizontal wipe instead of the previous uniform fade.
- **Leaderboard engine** — `src/engine/leaderboard.js` adds five exports: pure functions `isTopTen`, `insertScore`, `rankEntries` (no DOM or localStorage dependency, fully testable in Node) and thin localStorage wrappers `loadLeaderboard`/`saveLeaderboard` (key: `tron-tetris-leaderboard`). Entries are `{ initials: string, score: number }`, capped at 10, sorted descending.
- **Initials entry UI** — On game over with a qualifying score, a 3-character arcade-style prompt appears in the overlay. A–Z and 0–9 are accepted; cursor auto-advances; Backspace deletes; Enter submits when 3 characters are filled. Non-qualifying scores skip the prompt and go straight to the leaderboard table.
- **Game-over overlay redesign** — The `#overlay` now contains: final score, initials prompt (hidden until qualifying score), a ranked top-10 leaderboard table (new entry highlighted in white/cyan), and the PLAY AGAIN button. All elements use the existing Tron neon aesthetic (dark background, `#00ffff` glow, monospace). Table is populated from localStorage on every game over.
- **`input.js` unit tests via jsdom** — `vitest.config.js` gained `environmentMatchGlobs` so `input.test.js` runs in jsdom. `setupInput` gained a `suppressRestart: () => boolean` option to gate the Enter/R restart handler during initials entry. Six tests cover Enter/R restart, the game-over guard, and the suppress option.
- **localStorage wrapper tests** — `leaderboard-storage.test.js` (3 tests, jsdom environment) covers `loadLeaderboard` returning `[]` on a missing key and the `saveLeaderboard` → `loadLeaderboard` round-trip.
- **Vercel deploy readiness** — Vite's `dist/` output is a standard static site; no `vercel.json` is needed. Documented in `AGENTS.md`.
- **Documentation** — `AGENTS.md` updated with the leaderboard module API; `README.md` updated with local leaderboard feature and a Deploy section.

### How to Run It
```
npm install
npm run dev      # open localhost:5173
```
All Phase 1 and 2 controls still apply. New in Phase 3: on game over with a high score, type 3 characters (A–Z / 0–9) for your initials and press Enter (or wait — see known bug below). The ranked leaderboard table appears, with your new entry highlighted. Non-qualifying scores show the table immediately. R or Enter restarts. Scores persist across page reloads.

Production build: `npm run build && npm run preview` (serves at `localhost:4173`).

### Review Findings
- **Enter key race condition (critical, not yet fixed):** `handleInitialsKey` is registered on `window` *before* `setupInput`. When Enter is pressed to submit 3 initials, `handleInitialsKey` fires first and sets `initialsActive = false`; the `setupInput` listener fires immediately after, sees `!suppressRestart() === true`, and calls `handleRestart()`. The game restarts before the user sees the leaderboard table. The fix is to register `handleInitialsKey` after `setupInput`, or consolidate the two handlers. Deferred to Phase 4.
- **Potential XSS in `showLeaderboard` (minor, not fixed):** `tr.innerHTML` concatenates raw `entry.initials` and `entry.score` strings loaded from localStorage. Normal insertion path is safe (initials validated to `/^[A-Z0-9]$/`), but a manually edited localStorage value could inject HTML. Low risk for a local app; flagged as a bad pattern.
- **`input.test.js` listener accumulation (minor, not fixed):** Each `setupInput` call stacks another `keydown` listener on jsdom's shared `window`. Tests pass due to the `held` Set silencing repeat keys in older closures, but the isolation is fragile and order-dependent.
- **`isTopTen` assumes sorted input (minor, not fixed):** The function reads `entries[9].score` without verifying the array is sorted. If `loadLeaderboard` ever returns unsorted data, `isTopTen` silently misbehaves.
- **Duplicate test case (minor, not fixed):** `isTopTen(0, [])` asserted twice in `leaderboard.test.js`.

### What's Next
- **Phase 4 must fix the Enter-key race before building on top of it.** The leaderboard UX is broken at runtime; the fix is small (listener order or consolidation).
- **Phase 4:** 3D block geometry and Y-axis tilt — swap `OrthographicCamera` → `PerspectiveCamera`, flat blocks → `BoxGeometry(0.85, 0.85, 0.85)`, add directional key light, switch tilt axis from `rotation.z` → `rotation.y`.
- **Phase 5:** Playwright e2e testing and gameplay video recording.
- **Phase 6:** Start screen, pause on ESC, resume on any key.
- **Known limitations:** Enter-submit race makes leaderboard confirmation invisible; keyboard-only controls (no mobile touch); `loadLeaderboard`/`saveLeaderboard` error paths covered by tests but XSS risk in `showLeaderboard` unaddressed.

### Test Coverage
- **Test command:** `npm run test` / `npm run test:coverage`
- **Results:** 203 tests passing, 0 failing across 11 test files
- **New test files added this phase:** `leaderboard.test.js` (20 tests), `leaderboard-storage.test.js` (3 tests), `input.test.js` (6 tests), `sweep.test.js` (7 tests); plus additions to `tilt.test.js` (15 tests total, up from 11)
- **Coverage (engine modules):**

  | File           | Stmts  | Branch | Funcs  | Lines  |
  |----------------|--------|--------|--------|--------|
  | board.js       | 100%   | 100%   | 100%   | 100%   |
  | gameState.js   | 97.8%  | 95.31% | 86.95% | 97.8%  |
  | ghost.js       | 100%   | 100%   | 100%   | 100%   |
  | leaderboard.js | 100%   | 100%   | 100%   | 100%   |
  | rotation.js    | 100%   | 81.81% | 100%   | 100%   |
  | tetrominoes.js | 100%   | 100%   | 100%   | 100%   |
  | tilt.js        | 100%   | 100%   | 100%   | 100%   |
  | **All files**  | **99%** | **95.83%** | **93.33%** | **99%** |

- Engine line coverage: **99%** (target: ≥ 80%)
- Previously uncovered `leaderboard.js` localStorage wrappers are now at 100% via `leaderboard-storage.test.js` running in jsdom
- Still uncovered: `gameState.js` lines 162–168 (renderer-facing methods); `rotation.js` branches 27/29 (unreachable wall-kick edge cases); renderer modules (`scene.js`, `blockPool.js`, `composer.js`, `render.js`, `hud.js`) — all require WebGL context unavailable in Node

---

## Phase 4: True 3D Blocks and Y-Axis Tilt

### What We Built
- **Enter-key race condition fixed** — `setupInput` is now registered before `window.addEventListener('keydown', handleInitialsKey)` in `main.js`. The previous order caused key-repeat Enter events to bypass the `suppressRestart` guard and restart the game immediately after initials submission. With the fix, the `held` Set in `setupInput` silences key-repeat restarts, so the leaderboard table is visible after pressing Enter.
- **PerspectiveCamera** — `OrthographicCamera` removed from `scene.js`. Replaced with `PerspectiveCamera` (FOV 50°, Z = 26, near = 0.1, far = 100). Camera Z was derived from board geometry (24 world-unit visible height, tan(25°) ≈ 0.466). Resize handler now updates `camera.aspect` and calls `updateProjectionMatrix()`.
- **True 3D cube geometry** — Block geometry in `blockPool.js` changed from `BoxGeometry(0.95, 0.95, 0.1)` (thin slab) to `BoxGeometry(0.85, 0.85, 0.85)` (true cube). Block Z center updated to `0.425` (half of 0.85 depth, flush with board plane at Z = 0).
- **Directional key light** — `DirectionalLight(0xffffff, 1.0)` added to scene at position `(5, 10, 10)` (front-top-right). Material `roughness` raised from 0.2 → 0.4 so face shading contrast (top face brighter than front face) is visible without washing out neon colors. `AmbientLight` kept for fill.
- **Y-axis board tilt** — Tilt changed from `boardGroup.rotation.z` (screen-plane tilt) to `boardGroup.rotation.y` (depth tilt toward viewer). Formula: `boardGroup.rotation.y = THREE.MathUtils.degToRad(-gameState.tiltAngle)`. Negation required because `computeTiltAngle` returns negative for left-of-center, but Three.js positive Y rotation brings the left edge toward the viewer. `tilt.js` engine functions unchanged.
- **Grid/background verified** — Grid lines (Z = 0.02) sit inside the block volume; hidden behind block front faces in occupied cells, visible in empty cells. Background plane (Z = −0.05) behind everything. No depth-fighting changes needed.
- **Integration test for race condition** — New `src/__tests__/initials-submit.test.js` (jsdom) with 3 tests: (1) single Enter during initials calls submit not restart, (2) key-repeat Enter after submit does not restart (held Set blocks it), (3) fresh Enter after release restarts correctly. `vitest.config.js` updated with new jsdom entry. A fourth test was written and deleted after review identified it as a false positive.
- **CLAUDE.md documentation** — Rendering section added documenting PerspectiveCamera, `rotation.y` tilt formula, block geometry, and lighting as of Phase 4.

### How to Run It
```
npm install
npm run dev      # open localhost:5173
```
All previous controls still apply. New in Phase 4: blocks appear as 3D cubes with visible face shading. Moving the active piece left causes the left edge of the board to lean toward you; moving right causes the right edge to lean toward you. Submitting initials by pressing Enter now correctly shows the leaderboard table without restarting the game.

Production build: `npm run build && npm run preview` (serves at `localhost:4173`). Deploys to Vercel with no config file needed.

### Review Findings
- **Camera Z discrepancy (no action needed):** The SPEC estimated camera Z "~18 units" but the PLAN's camera math (FOV 50°, 24-unit board height) correctly derived Z = 26. Implementation uses Z = 26. The spec contained a stale estimate; the plan override was correct.
- **False-positive test 4 identified and deleted:** `initials-submit.test.js` originally had a 4th test claiming to verify `suppressRestart`, but it actually passed because `handleInitialsKey`'s `stopImmediatePropagation` blocked the inner listener entirely — not because of `suppressRestart`. The test was deleted; `suppressRestart` is correctly covered by `input.test.js:66–71`. Final count: 3 tests in `initials-submit.test.js`.
- **Race condition fix verified correct:** Listener registration order analysis confirmed `setupInput` first → `handleInitialsKey` second is the correct fix. The `held` Set ensures key-repeat Enter events are swallowed after submit.
- **`rotation.z` residual (not an issue):** No explicit reset needed — Three.js defaults rotation components to 0, and the Phase 4 code never writes `rotation.z`.
- **Phase 4 commit pending:** The pipeline commit step handles this; the build agent completed all code changes but did not commit.

### What's Next
- **Phase 5:** Playwright e2e testing and gameplay video recording — install `@playwright/test`, configure `playwright.config.ts` against `npm run preview`, enable video recording, write `tests/gameplay.spec.ts` covering canvas visible, piece moves, line clear + score increase, game-over overlay.
- **Phase 6:** Start screen (game doesn't begin until button/keypress), ESC to pause, any key to resume.
- **Known limitations:** Keyboard-only controls (no mobile touch); `rotation.z` never explicitly reset (low risk — defaults to 0); board/grid Z compatibility is visually verified only with no automated regression guard; `initials-submit.test.js` lacks an Enter-with-fewer-than-3-chars scenario.
- **Remaining debt from earlier phases:** `isTopTen` assumes sorted input; potential XSS in `showLeaderboard` via raw `innerHTML` (low risk — inputs validated at entry); `input.test.js` listener accumulation across tests.

### Test Coverage
- **Test command:** `npm run test` / `npm run test:coverage`
- **Results:** 206 tests passing, 0 failing across 12 test files
- **New test file added this phase:** `initials-submit.test.js` (3 tests, jsdom)
- **Coverage (engine modules):**

  | File           | Stmts  | Branch | Funcs  | Lines  |
  |----------------|--------|--------|--------|--------|
  | board.js       | 100%   | 100%   | 100%   | 100%   |
  | gameState.js   | 97.8%  | 95.31% | 86.95% | 97.8%  |
  | ghost.js       | 100%   | 100%   | 100%   | 100%   |
  | leaderboard.js | 100%   | 100%   | 100%   | 100%   |
  | rotation.js    | 100%   | 81.81% | 100%   | 100%   |
  | tetrominoes.js | 100%   | 100%   | 100%   | 100%   |
  | tilt.js        | 100%   | 100%   | 100%   | 100%   |
  | **All files**  | **99%** | **95.83%** | **93.33%** | **99%** |

- Engine line coverage: **99%** (target: ≥ 80%) — unchanged from Phase 3, no engine code modified
- Still uncovered: `gameState.js` lines 162–168 (renderer-facing methods exercised only via `render.js`); `rotation.js` branches 27/29 (unreachable wall-kick paths); renderer modules (`scene.js`, `blockPool.js`, `composer.js`, `render.js`, `hud.js`) — all require WebGL context unavailable in Node; no E2E tests (Phase 5)

---

## Phase 5: Playwright E2E Testing & Gameplay Video Recording

### What We Built
- **Playwright installed** — `@playwright/test` added as a devDependency; Chromium browser binary downloaded locally
- **`playwright.config.ts`** — Chromium-only, headless, `video: 'on'` (every test generates a `.webm`), `retries: 1`, HTML reporter, `webServer` block that starts `npm run preview` at `localhost:4173` before tests run
- **`--use-gl=angle` launch flag** — Required for WebGL to work in headless Chromium; without it SwiftShader fails with "BindToCurrentSequence failed" and `window.__gameState` is never populated. Added to `launchOptions.args` in `playwright.config.ts`.
- **`window.__gameState` test hook** — One line added to `src/main.js` (after `let gameState = new GameState()`) exposing the live game state globally, enabling board-state injection via `page.evaluate()`. Exposed unconditionally for Phase 5; Phase 6 should gate behind a build flag.
- **`tests/gameplay.spec.ts`** — Five E2E test scenarios covering the full game loop:
  1. Canvas visible and score starts at `"0"` on load
  2. Left ×3, right ×2, rotate ×1 sequence does not crash the game
  3. Board injection (rows 16–19, cols 1–9 filled) + vertical I-piece hard drop → 4-line clear → score increases from `"0"`
  4. O-piece spawn cells pre-filled → active O dropped → game-over overlay becomes visible
  5. Same game-over trigger → type `"AAA"` → press Enter → leaderboard row with `"AAA"` appears
- **`npm run test:e2e`** and **`npm run test:e2e:ui`** scripts added to `package.json`
- **`.gitignore` created** — excludes `test-results/`, `playwright-report/`, `dist/`, `node_modules/`, `coverage/`
- **Documentation** — CLAUDE.md, README.md, and AGENTS.md updated with E2E test instructions and the requirement to `npm run build` before running E2E tests

### How to Run It
```
npm install
npm run build        # required — E2E tests run against the production preview server
npm run test:e2e     # 5 Playwright tests, headless Chromium, .webm artifacts in test-results/
npm run test:e2e:ui  # Playwright UI mode (manual verification)
npm test             # 206 Vitest unit tests (unchanged)
```
After `npm run test:e2e`, open `npx playwright show-report` to view the HTML test report with embedded video recordings.

For the live game: `npm run dev` → `localhost:5173` (all Phase 1–4 features intact).

### Review Findings
- **Redundant `BASE` constant (not fixed, deferred to Phase 6):** `tests/gameplay.spec.ts` hardcodes `const BASE = 'http://localhost:4173'` and uses `page.goto(BASE)` instead of `page.goto('/')`. The `playwright.config.ts` already sets `baseURL` — the constant duplicates it and will silently break if the port changes. Carry-over debt for Phase 6.
- **Stale RAF comment (not fixed, deferred):** A comment in the spec says `window.__gameState` is set "on first RAF frame" — it's actually set synchronously at module evaluation, not inside the animation loop. Future maintainers could misread the lifecycle.
- **Test 2 assertion is too weak (not fixed, deferred):** After simulating key inputs, the test only checks `#hud-score` is visible — which it always is regardless of whether inputs were processed. Does not detect a silently erroring RAF loop. Should verify `gameState.over === false` instead.
- **Test 3 assertion is imprecise (not fixed, deferred):** `not.toHaveText('0')` passes for any non-zero text including incorrect values. The expected score is deterministically `800` (4-line Tetris at level 1); assertion should be `toHaveText('800')`.
- **Missing boundary tests (out of spec, deferred):** No coverage for: 4th-character rejection in initials entry, Backspace to delete an initials character, or non-top-10 game-over path where the leaderboard section should stay hidden.
- **`window.__gameState` ungated in production (low urgency, deferred):** Exposed unconditionally in `main.js`; Phase 6 should add a `VITE_TEST_HOOKS` build-flag gate.
- **`--use-gl=angle` is a platform-specific workaround:** Verified working on macOS/Darwin. If CI runs Linux, this flag should still be effective but worth re-verifying.

### What's Next
- **Phase 6 pre-work:** Fix the three REVIEW.md carryover issues in `tests/gameplay.spec.ts` (remove `const BASE`, fix stale comment, strengthen Test 2 and Test 3 assertions) before writing any new tests.
- **Phase 6 features:** Start screen (game waits for keypress/click before starting), ESC to pause with "PAUSED" overlay, any key to resume. E2E tests for all three flows required in the same phase.
- **Known limitations heading into Phase 6:** Keyboard-only controls (no mobile touch); `window.__gameState` exposed in production build; stale Phase 2 Z-axis rotation snippet still in AGENTS.md; weak assertions in Tests 2 and 3 could hide future regressions.

### Test Coverage
- **Test command:** `npm test` (Vitest) and `npm run build && npm run test:e2e` (Playwright)
- **Vitest results:** 206 tests passing, 0 failing, 12 test files — identical to Phase 4 baseline (no unit tests added or removed this phase)
- **Playwright results:** 5 tests passing, 0 failing — all 5 spec scenarios delivered
- **Video artifacts:** `test-results/` contains one `.webm` per test per run (5 videos on a clean run)
- **Vitest engine coverage (unchanged from Phase 4):**

  | File           | Stmts  | Branch | Funcs  | Lines  |
  |----------------|--------|--------|--------|--------|
  | board.js       | 100%   | 100%   | 100%   | 100%   |
  | gameState.js   | 97.8%  | 95.31% | 86.95% | 97.8%  |
  | ghost.js       | 100%   | 100%   | 100%   | 100%   |
  | leaderboard.js | 100%   | 100%   | 100%   | 100%   |
  | rotation.js    | 100%   | 81.81% | 100%   | 100%   |
  | tetrominoes.js | 100%   | 100%   | 100%   | 100%   |
  | tilt.js        | 100%   | 100%   | 100%   | 100%   |
  | **All files**  | **99%** | **95.83%** | **93.33%** | **99%** |

- Engine coverage target (≥ 80%): **met at 99%**
- E2E tests cover the renderer/browser layer that unit tests cannot reach (WebGL context required)
- Still uncovered by unit tests: `gameState.js` lines 162–168 (renderer-facing methods); `rotation.js` branches 27/29 (unreachable wall-kick paths); all renderer modules

---
