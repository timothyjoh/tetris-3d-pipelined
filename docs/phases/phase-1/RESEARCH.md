# Research: Phase 1

## Phase Context

Phase 1 asks us to build a fully playable Tetris game in the browser with a Tron-inspired neon aesthetic rendered via Three.js. The deliverable is a Vite-scaffolded Vanilla JS / ES Modules project containing a complete Tetris engine (10×20 grid, all 7 tetrominoes, SRS wall kicks, gravity, lock delay, scoring, leveling, game over), a Three.js WebGL renderer with orthographic camera, neon block materials using `MeshStandardMaterial`/`MeshBasicMaterial` with emissive color, a grid-line overlay, `UnrealBloomPass` post-processing via `EffectComposer`, an HTML/CSS HUD overlay (score, level, lines, next-piece preview), and a minimal game-over/restart prompt. Board tilt and sound are explicitly deferred to Phase 2. The game must run at 60fps, all Vitest unit tests must pass, engine coverage must be ≥ 80%, and `vite build` must produce a clean `dist/` output.

## Previous Phase Learnings

First phase — no prior reflections.

## Current Codebase State

### Scaffold & Repository

The repository was initialized with a single commit (`fcb8f72 init: cc-pipeline scaffold + BRIEF.md`). There is no application source code. The root contains exactly five files/directories visible to the project (excluding `.git` and `.pipeline`):

- `BRIEF.md` — Project brief describing Tron Tetris across all three planned phases — `BRIEF.md:1`
- `BRIEF.md.example` — Template used to author the brief, not part of the build
- `CLAUDE.md` — Claude Code conventions; instructs agents to read `AGENTS.md` first (that file does not yet exist) and documents the cc-pipeline workflow — `CLAUDE.md:1`
- `package.json` — Present but configured for an unrelated `mdtoc` CLI tool, not the Tetris game — `package.json:1`
- `docs/phases/phase-1/SPEC.md` — The spec for this phase, generated by the pipeline — `docs/phases/phase-1/SPEC.md:1`

### Relevant Components

There are **no application source files** in the repository. The following directories and files called for by the SPEC do not yet exist:

- `src/` — No source directory
- `index.html` — No entry HTML
- `vite.config.js` — No Vite configuration
- `src/engine/` or equivalent — No Tetris engine modules
- `src/__tests__/` or `*.test.js` — No test files
- `vitest.config.js` — No Vitest configuration
- `AGENTS.md` — Referenced in `CLAUDE.md:3` as a required read, but not yet created
- `README.md` — Not yet created

### Existing Patterns to Follow

No application code patterns exist yet. The following conventions are established by the scaffold:

- **Module type**: `package.json:7` sets `"type": "module"`, so all JS files must use ES Module syntax (`import`/`export`), not CommonJS `require`.
- **Node version floor**: `package.json:13–15` specifies `"node": ">=18"`, matching the SPEC dependency requirement.
- **Pipeline output convention**: `workflow.yaml:18` sets `phases_dir: "docs/phases"`, meaning all phase artifacts (SPEC, RESEARCH, PLAN, REVIEW, REFLECTIONS, REVIEW) live under `docs/phases/phase-N/`.
- **Test command in scaffold**: `package.json:10` currently runs `node --test src/**/*.test.js` — this will be replaced by Vitest per the SPEC.

### cc-Pipeline Workflow

The `.pipeline/` directory contains the full pipeline configuration:

- `.pipeline/workflow.yaml` — Defines the 9-step pipeline: spec → research → plan → build (interactive) → review → fix → reflect → status → commit — `workflow.yaml:20–77`
- `.pipeline/prompts/` — One `.md` prompt file per pipeline step (build, commit, fix, plan, reflect, research, review, spec, status)
- `.pipeline/pipeline.jsonl` — Runtime state file tracking completed steps; written by the pipeline runner
- `.pipeline/step-output.log` — Log of prior pipeline step outputs
- `.pipeline/CLAUDE.md` — Pipeline configuration documentation

The build step (`workflow.yaml:45–48`) is `claude-interactive` with `test_gate: true`, meaning the pipeline will run tests and block progress if they fail.

### Dependencies & Integration Points

No `node_modules` or lockfile exists. The following packages must be installed fresh per the SPEC:

- `vite` (devDependency) — Build tool and dev server; target: `localhost:5173`
- `three` — 3D rendering library; provides `WebGLRenderer`, `OrthographicCamera`, `Scene`, `Mesh`, `MeshStandardMaterial`, `MeshBasicMaterial`, `BoxGeometry`, `PlaneGeometry`
- `vitest` (devDependency) — Test framework replacing the current `node --test` runner
- `@vitest/coverage-v8` (devDependency) — V8-based coverage reporter; target output: `coverage/`
- `postprocessing` or Three.js bundled `examples/jsm/postprocessing/` — Provides `EffectComposer` and `UnrealBloomPass`

The SPEC (`SPEC.md:97`) lists `postprocessing` (npm package) **or** Three.js `examples/jsm/postprocessing/` as acceptable. The Three.js jsm path is bundled with the `three` package and avoids an extra dependency.

### Frontend-Design Skill

A `.claude/skills/frontend-design/SKILL.md` skill is registered at `skills/frontend-design/SKILL.md:1`. It provides aesthetic guidelines for building production-grade frontends with distinctive visual design. Relevant guidance for this phase includes: commit to a specific aesthetic direction (Tron neon-retro is already defined in the BRIEF), use CSS variables for theme consistency, use motion and animation for high-impact moments, avoid generic font and color choices.

### Test Infrastructure

No test infrastructure exists yet. The SPEC defines:

- **Framework**: Vitest with `@vitest/coverage-v8`
- **Test location**: `src/__tests__/` or co-located `*.test.js` files
- **Coverage target**: ≥ 80% line coverage on engine modules
- **npm scripts to add**: `test` → `vitest run`, `test:coverage` → `vitest run --coverage`
- **No E2E tests required**

Key test scenarios per SPEC (`SPEC.md:69–78`): tetromino spawning, rotation + wall kicks, movement boundary checks, lock delay behavior, line clear correctness, scoring math, level progression, game over detection, gravity interval per level.

## Code References

- `BRIEF.md:1–52` — Full project brief: Tron Tetris, three-phase plan, full feature list, tech stack
- `BRIEF.md:47–52` — Phase breakdown: Phase 1 = engine + render + aesthetic; Phase 2 = tilt + sound; Phase 3 = leaderboard
- `CLAUDE.md:3–5` — Instruction to read `AGENTS.md` first (file not yet created)
- `CLAUDE.md:9–67` — cc-pipeline documentation: how to run, step order, where outputs go
- `package.json:7` — `"type": "module"` — ES Modules required
- `package.json:10` — Existing test command (`node --test`) to be replaced by Vitest
- `package.json:13` — `"node": ">=18"` engine constraint
- `.pipeline/workflow.yaml:20–77` — Full step definitions with agents, prompts, test gates
- `.pipeline/workflow.yaml:45–48` — Build step: `claude-interactive`, `test_gate: true`
- `docs/phases/phase-1/SPEC.md:1–101` — Complete Phase 1 specification
- `SPEC.md:10–22` — In-scope items: Vite scaffold, Vitest, engine, Three.js scene, Tron aesthetic, bloom, HUD, game over
- `SPEC.md:23–29` — Out of scope: board tilt, sound, spring animation, leaderboard
- `SPEC.md:32–44` — Non-functional requirements: 60fps, SRS, WebGLRenderer, EffectComposer, MeshStandardMaterial/MeshBasicMaterial, clean build
- `SPEC.md:65–80` — Testing strategy: framework, location, key scenarios, coverage target
- `SPEC.md:83–86` — Documentation required: AGENTS.md (new), CLAUDE.md (update, keep existing), README.md (new)
- `SPEC.md:89–97` — Dependency list: vite, three, vitest, @vitest/coverage-v8, postprocessing or jsm

## Open Questions

- **`postprocessing` vs jsm**: The SPEC allows either the `postprocessing` npm package or Three.js's bundled `examples/jsm/postprocessing/`. The jsm path ships with `three` and avoids an extra dependency, but the `postprocessing` package may have a simpler API. The plan step should commit to one.
- **Directory structure for engine modules**: The SPEC mentions `engine/`, `game/`, or equivalent. A concrete directory layout (e.g., `src/engine/`, `src/renderer/`, `src/game.js`, `src/main.js`) needs to be decided in the plan.
- **`package.json` overwrite**: The current `package.json` is for the unrelated `mdtoc` tool. It needs to be fully replaced with a Tetris/Tron-Tetris package definition. The plan should confirm this is a clean replacement rather than a merge.
- **HUD implementation approach**: The SPEC specifies HTML/CSS overlay over the Three.js canvas. The plan should define whether this is static HTML in `index.html` or dynamically generated in JS.
- **Grid-line overlay technique**: The SPEC calls for a "subtle grid-line overlay on the board surface." The plan should specify whether this is a Three.js `LineSegments` mesh, a shader-based approach, or a canvas/CSS overlay.
